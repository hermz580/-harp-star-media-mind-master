<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>HARP*STAR: SWARM NEXUS</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              'orbitron': ['"Orbitron"', 'sans-serif'],
              'mono': ['"Roboto Mono"', 'monospace'],
            },
            colors: {
              'sci-bg': '#05070a',
              'primary': '#6366f1',
              'secondary': '#06b6d4',
              'neon-cyan': '#00ffcc',
              'neon-magenta': '#ff00ff',
              'neon-lime': '#00ff00',
            }
          }
        }
      }
    </script>
    <style>
        body {
            background-color: #050510;
            color: #e0e0e0;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(255, 0, 255, 0.05), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(0, 255, 204, 0.05), transparent 25%),
                linear-gradient(rgba(0, 255, 204, 0.03) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(0, 255, 204, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
            font-family: 'Roboto Mono', monospace;
        }

        .sci-box {
            background: rgba(13, 20, 31, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 255, 204, 0.2);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 255, 204, 0.05);
            position: relative;
        }

        .sci-box::before {
            content: ''; position: absolute; top: 0; left: 0; width: 8px; height: 8px;
            border-top: 2px solid #00ffcc; border-left: 2px solid #00ffcc;
        }

        .glow-text-cyan { text-shadow: 0 0 10px rgba(0, 255, 204, 0.5); }
        
        .scanline {
            width: 100%; height: 100px; z-index: 50; pointer-events: none;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(0, 255, 204, 0.02) 50%, rgba(0,0,0,0) 100%);
            position: absolute; bottom: 100%; animation: scanline 8s linear infinite;
        }

        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100px; } }

        .agent-talk-bubble {
            animation: slideIn 0.3s ease-out;
            border-left-width: 3px;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 255, 204, 0.2); border-radius: 2px; }

        #lockdown-screen {
            display: none; position: fixed; inset: 0; background: black; z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center;
            color: #ff0055; text-align: center;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden">
    <div id="lockdown-screen">
        <span class="material-symbols-outlined text-8xl animate-pulse">lock_person</span>
        <h1 class="font-orbitron text-4xl mt-4">BRAND LOCKDOWN</h1>
        <p class="font-mono mt-2 opacity-50">Integrity Mismatch. Access Revoked.</p>
    </div>

    <div class="scanline"></div>

    <header class="h-20 border-b border-white/10 bg-black/40 backdrop-blur-md flex items-center justify-between px-8 z-30 shrink-0">
        <div>
            <h1 id="sys-name" class="font-orbitron text-xl font-black tracking-tighter text-white glow-text-cyan uppercase">
                HARP*STAR <span class="text-neon-cyan">MEDIA MIND-MASTER</span>
            </h1>
            <div class="flex items-center gap-3 mt-1">
                <span class="text-[9px] text-neon-magenta font-bold tracking-[0.3em]">SWARM NEXUS // FOCUS:</span>
                <input id="focus-input" type="text" class="bg-transparent border-none p-0 text-[10px] text-white focus:ring-0 w-64 italic" onchange="updateFocus(this.value)">
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="executeSync()" class="bg-neon-cyan/10 border border-neon-cyan/40 text-neon-cyan px-4 py-1.5 font-orbitron text-[10px] font-bold tracking-widest hover:bg-neon-cyan hover:text-black transition-all">SYNC DNA</button>
            <button onclick="discoverSystem()" class="bg-amber-500/10 border border-amber-500/40 text-amber-500 px-4 py-1.5 font-orbitron text-[10px] font-bold tracking-widest hover:bg-amber-500 hover:text-black transition-all">SCAN SYSTEM</button>
        </div>
    </header>

    <main class="flex-grow flex overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-80 border-r border-white/5 p-6 flex flex-col gap-6 bg-black/20 shrink-0">
            <div class="sci-box p-4 border-primary/30">
                <h3 class="font-orbitron text-[10px] items-center flex gap-2 text-primary font-bold mb-4 uppercase">
                    <span class="material-symbols-outlined text-sm">database</span> Knowledge Roots
                </h3>
                <div id="roots-list" class="space-y-4 max-h-64 overflow-y-auto pr-2"></div>
            </div>

            <div class="sci-box p-4 border-neon-magenta/30">
                <h3 class="font-orbitron text-[10px] items-center flex gap-2 text-neon-magenta font-bold mb-4 uppercase">
                    <span class="material-symbols-outlined text-sm">language</span> Inspiration Roots
                </h3>
                <div id="inspiration-list" class="space-y-2"></div>
                <button onclick="addInspiration()" class="w-full mt-4 border border-white/10 py-1 text-[10px] text-slate-500 hover:text-white transition-colors">ADD ROOT</button>
            </div>

            <div class="sci-box p-4 border-neon-lime/30 flex-grow">
                <h3 class="font-orbitron text-[10px] items-center flex gap-2 text-neon-lime font-bold mb-4 uppercase">
                    <span class="material-symbols-outlined text-sm">hub</span> Platforms
                </h3>
                <div id="platforms-list" class="space-y-2"></div>
            </div>
        </aside>

        <!-- Main Column -->
        <div class="flex-grow flex flex-col p-6 gap-6 overflow-hidden">
            <div class="flex justify-between items-center">
                <h2 class="font-orbitron text-lg font-bold text-white flex items-center gap-3 italic">
                    <span class="size-2 rounded-full bg-neon-cyan shadow-[0_0_8px_#00ffcc] animate-pulse"></span>
                    Intelligence Pipeline
                </h2>
                <button onclick="proposeWorkflows()" class="bg-secondary/20 hover:bg-secondary/40 text-secondary text-[10px] font-bold px-6 py-2 border border-secondary/50 rounded uppercase tracking-widest transition-all">PROCESS BUCKET</button>
            </div>

            <div id="workflow-pipeline" class="flex-grow sci-box p-6 overflow-y-auto space-y-4 custom-scrollbar">
                <div class="flex items-center justify-center h-full text-slate-600 text-xs italic tracking-widest">AWAITING ASSET INJECTION...</div>
            </div>

            <!-- Creative Control Pad -->
            <div class="sci-box p-5 border-white/10 bg-black/40">
                <div class="flex items-center gap-3 mb-3">
                    <span class="material-symbols-outlined text-neon-cyan animate-pulse">psychology</span>
                    <span class="font-orbitron text-[10px] font-bold uppercase tracking-widest text-slate-400">Creative Steering</span>
                </div>
                <textarea id="creative-steering" placeholder="Optional: Ignite the swarm with a spark or direction..." 
                    class="w-full h-16 bg-black/60 border border-white/5 rounded p-3 text-[11px] text-slate-300 placeholder:text-slate-700 focus:outline-none focus:border-neon-cyan/50 transition-all resize-none font-mono"></textarea>
            </div>
        </div>

        <!-- Right Terminal -->
        <aside class="w-96 border-l border-white/5 p-6 flex flex-col gap-6 bg-black/20 shrink-0">
            <div class="sci-box p-6 border-primary/30 text-center">
                <div class="size-16 mx-auto mb-4 relative">
                    <div class="absolute inset-0 border-2 border-primary/20 rounded-full animate-spin"></div>
                    <span class="material-symbols-outlined text-primary text-3xl absolute inset-0 flex items-center justify-center">insights</span>
                </div>
                <h3 class="font-orbitron text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-3">V-Brain Core</h3>
                <p id="thought-display" class="text-[10px] text-primary italic font-mono min-h-[40px]">"Synchronizing with brand mission."</p>
            </div>

            <div class="sci-box flex-grow flex flex-col overflow-hidden border-white/10">
                <div class="px-4 py-2 border-b border-white/10 flex justify-between items-center bg-black/40">
                    <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Swarm Terminal</span>
                    <span class="text-[8px] text-neon-lime animate-pulse font-mono">LIVE_FEED</span>
                </div>
                <div id="agent-terminal" class="flex-grow p-4 overflow-y-auto space-y-4 font-mono text-[10px] bg-black/20"></div>
                <div class="p-4 border-t border-white/10 flex items-center gap-3 bg-black/40">
                    <span class="text-neon-cyan text-xs font-bold font-mono">></span>
                    <input type="text" placeholder="DIRECT COMMAND..." class="flex-grow bg-transparent border-none focus:ring-0 text-[10px] text-white placeholder:text-slate-700 uppercase p-0">
                </div>
            </div>
        </aside>
    </main>

    <footer class="h-8 bg-black/80 border-t border-white/10 flex items-center justify-between px-8 z-30 shrink-0">
        <div class="flex items-center gap-6">
            <span class="text-[8px] text-slate-600 font-bold uppercase tracking-widest">Neural Learning Curve</span>
            <div class="w-48 h-1 bg-white/5 rounded-full overflow-hidden">
                <div id="learning-bar" class="h-full bg-neon-cyan w-0 transition-all duration-1000 shadow-[0_0_10px_#00ffcc]"></div>
            </div>
            <span id="root-count-display" class="text-[8px] text-slate-500 font-mono">0 ROOTS CONNECTED</span>
        </div>
        <div id="active-stats" class="text-[8px] text-slate-700 font-mono uppercase tracking-[0.3em]">Harp*Star Media Mind Master // v2.6 // OS_CONNECTED</div>
    </footer>

    <!-- Drop Zone Integration -->
    <div id="drop-zone" class="hidden"></div> <!-- Replaced functionality with simple file trigger if needed -->
    <input type="file" id="file-input" class="hidden" multiple />

    <script>
        const req = async (p, o = {}) => {
            try { return (await fetch(p, o)).json(); }
            catch(e) { console.error("API Error", e); return { status: 'error' }; }
        };

        async function load() {
            const s = await req("/api/status");
            if (s.status === 'error') return;
            
            document.getElementById("focus-input").value = s.global_focus || "BRAND SOVEREIGNTY";

            const rootsList = document.getElementById("roots-list");
            rootsList.innerHTML = (s.roots || []).map((r, i) => `
                <div class="p-3 bg-white/5 border border-white/5 rounded hover:border-primary/50 transition-all">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-[10px] font-bold text-white truncate w-4/5 uppercase">${r.split('/').pop() || r}</span>
                        <span class="size-1.5 rounded-full ${i == 0 ? 'bg-neon-cyan shadow-[0_0_5px_#00ffcc]' : 'bg-slate-700'}"></span>
                    </div>
                </div>
            `).join("");

            document.getElementById("platforms-list").innerHTML = Object.entries(s.platforms || {}).map(([k, v]) => `
                <div class="flex items-center justify-between p-2 rounded bg-white/[0.02] border border-transparent hover:border-neon-lime/20 transition-all">
                    <span class="text-[10px] text-slate-300 capitalize font-mono tracking-tighter">${k}</span>
                    <span class="text-[8px] font-bold ${v.status == 'connected' ? 'text-neon-lime' : 'text-slate-700'}">${v.status.toUpperCase()}</span>
                </div>
            `).join("");

            const p = Math.min((s.roots || []).length * 25, 100);
            document.getElementById("learning-bar").style.width = p + "%";
            document.getElementById("root-count-display").innerText = `${(s.roots || []).length} ROOTS SYNCED`;
            loadWorkflows();
        }

        async function updateFocus(v) {
            await req("/api/focus/update", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ focus: v }) });
            setThought(`Strategic Focus recalibrated: ${v}`);
        }

        async function addInspiration() {
            const url = prompt("Enter Brand URL:");
            if (!url) return;
            const data = await req('/api/inspiration/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            renderInspiration(data.inspiration_urls);
        }

        function renderInspiration(urls) {
            const list = document.getElementById("inspiration-list");
            list.innerHTML = (urls || []).map(url => `
                <div class="flex items-center gap-2 p-2 bg-white/5 rounded border border-white/5">
                    <span class="text-[9px] text-slate-400 truncate flex-1 font-mono">${new URL(url).hostname}</span>
                </div>
            `).join('') || '<div class="text-[8px] text-slate-700 italic">No roots found.</div>';
        }

        async function proposeWorkflows() {
            setThought("Swarm analyzing media DNA...");
            const user_spark = document.getElementById("creative-steering").value;
            await req("/api/workflow/propose", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_spark })
            });
            load();
        }

        async function loadWorkflows() {
            const res = await req("/api/workflow/pending");
            const container = document.getElementById("workflow-pipeline");
            if (!res.workflows || res.workflows.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-500/30 font-orbitron text-xs animate-pulse">Awaiting Asset Manifestation...</div>`;
                return;
            }

            container.innerHTML = res.workflows.map(wf => `
                <div class="sci-box p-5 border-l-4 ${wf.status == 'completed' ? 'border-l-neon-lime' : 'border-l-secondary'} relative overflow-hidden group">
                    ${wf.free ? '<div class="absolute -right-8 top-1 bg-neon-lime/80 text-[7px] font-bold px-10 py-1 rotate-45 text-black">NO KEY</div>' : ''}
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="text-white font-bold text-sm tracking-tight mb-1 uppercase font-orbitron">${wf.plan.title}</h4>
                            <p class="text-slate-400 text-[10px] italic mb-3">"${wf.plan.story}"</p>
                            <div class="flex flex-wrap gap-2">
                                ${wf.plan.tasks.map(t => `<span class="bg-white/5 text-slate-500 text-[8px] px-2 py-0.5 rounded border border-white/5 font-mono">${t[0]}: ${t[1]}</span>`).join("")}
                            </div>
                        </div>
                        <button onclick="ignite('${wf.id}')" class="bg-neon-cyan/10 hover:bg-neon-cyan text-neon-cyan hover:text-black text-[9px] font-black px-5 py-2 border border-neon-cyan/40 transition-all uppercase font-orbitron">IGNITE</button>
                    </div>
                </div>
            `).join("");
        }

        async function ignite(id) {
            setThought("Launching Agentic Manifestation...");
            await req(`/api/workflow/execute/${id}`, { method: "POST" });
            load();
        }

        function setThought(t) {
            const d = document.getElementById("thought-display");
            d.style.opacity = "0";
            setTimeout(() => { d.innerText = `"${t}"`; d.style.opacity = "1"; }, 200);
        }

        async function executeSync() {
            await req("/api/sync", { method: "POST" });
            load();
        }

        async function discoverSystem() {
             const res = await req("/api/system/discover");
             if (res.potential?.length > 0) {
                 setThought(`${res.potential.length} new roots detected in system scan.`);
             }
        }

        // WebSockets
        function setupWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const socket = new WebSocket(`${protocol}//${window.location.host}/ws`);
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'swarm_talk') renderAgentSpeech(data);
            };
            socket.onclose = () => setTimeout(setupWebSocket, 5000);
        }

        function renderAgentSpeech(data) {
            const container = document.getElementById("agent-terminal");
            const html = `
                <div class="agent-talk-bubble border-l-2 border-${data.color} pl-3 py-1 bg-white/5 rounded-r">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-${data.color} font-bold text-[8px] uppercase tracking-tighter">${data.agent}</span>
                        <span class="text-[7px] text-slate-700 ml-auto font-mono">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="text-[10px] text-slate-300 italic font-mono leading-relaxed">"${data.message}"</div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
            setThought(`${data.agent}: ${data.message.substring(0, 30)}...`);
        }

        // Anti-Tamper
        setInterval(() => {
            if (document.getElementById("sys-name").innerText.toUpperCase() !== "HARP*STAR MEDIA MIND-MASTER") {
                document.getElementById("lockdown-screen").style.display = "flex";
                window.stop();
            }
        }, 1000);

        setupWebSocket();
        load();
    </script>
</body>
</html>